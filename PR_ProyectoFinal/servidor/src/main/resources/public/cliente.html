<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cliente Web</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .card {
            background: white;
            width: 420px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        h2 {
            text-align: center;
            margin-bottom: 15px;
        }

        input, button {
            width: 100%;
            padding: 8px;
            margin-top: 8px;
            box-sizing: border-box;
        }

        button {
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background: #125aa0;
        }

        #chat {
            display: none;
        }

        ul {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        li {
            padding: 6px;
            margin-bottom: 4px;
            border-radius: 5px;
            background: #eeeeee;
            font-size: 14px;
        }

        .udp {
            background: #fff3cd;
            border-left: 5px solid #ff9800;
        }

        .system {
            background: #e3f2fd;
        }

        .error {
            background: #ffcdd2;
        }

        .clientes {
            font-size: 13px;
            margin-top: 10px;
        }
         
        .btn-registro {
            background: #4CAF50;
            margin-top: 5px;
        }
        
        .btn-registro:hover {
            background: #388E3C;
        }
    </style>
</head>

<body>

<div class="card">

    <h2>Cliente Web</h2>

    <!-- LOGIN -->
    <div id="login">
        <input id="nombre" placeholder="Usuario">
        <input id="password" type="password" placeholder="Contra">
        <button onclick="conectar('LOGIN')">Entrar</button>
        <button onclick="conectar('REGISTER')" class="btn-registro">Registrar</button>
    </div>

    <!-- CHAT -->
    <div id="chat">
        <input id="mensaje" placeholder="Mensaje">
        <button onclick="enviar()">Enviar</button>

        <ul id="log"></ul>

        <div class="clientes">
            <strong>Clientes conectados:</strong>
            <ul id="listaClientes"></ul>
        </div>
    </div>

</div>

<script>
let ws;

function conectar(tipo) {
    const user = document.getElementById("nombre").value.trim();
    const pass = document.getElementById("password").value.trim();

    if (!user || !pass) {
        alert("Ingresa usuario y contra");
        return;
    }

    ws = new WebSocket("ws://localhost:8080/ws");

    ws.onopen = () => {
        console.log("Enviando " + tipo + ":", user);
        ws.send(tipo + ":" + user + ":" + pass);
    };

    ws.onmessage = (event) => {
        console.log("Mensaje del servidor:", event.data);

        // LOGIN OK
        if (event.data === "LOGIN_OK") {
            document.getElementById("login").style.display = "none";
            document.getElementById("chat").style.display = "block";
            document.getElementById("mensaje").focus();
            return;
        }

        // Error
        if (event.data.startsWith("nel") || event.data.includes("incorrecto") || 
            event.data.includes("invalido") || event.data.includes("obligatorios") ||
            event.data.includes("conectado") || event.data.includes("Error")) {
            alert(event.data);
            ws.close();
            return;
        }

        // Lista clientes
        if (event.data.startsWith("LISTA_CLIENTES:")) {
            const lista = event.data.replace("LISTA_CLIENTES:", "").split(",");
            document.getElementById("listaClientes").innerHTML = "";

            lista.forEach(c => {
                if (c.trim()) {
                    const li = document.createElement("li");
                    li.innerText = c;
                    document.getElementById("listaClientes").appendChild(li);
                }
            });
            return;
        }

        // Mensajes de conexiÃ³n/desconexion
        if (event.data.startsWith("ONLINE ") || event.data.startsWith("OFFLINE ")) {
            const li = document.createElement("li");
            li.innerText = event.data;
            li.className = "system";
            document.getElementById("log").appendChild(li);
            return;
        }

        // Mensajes normales
        const li = document.createElement("li");
        li.innerText = event.data;
        document.getElementById("log").appendChild(li);
    };

    ws.onclose = () => {
        console.log("Conexion cerrada");
    };

    ws.onerror = (error) => {
        console.error("Error WebSocket:", error);
        alert("Error de conexion con el servidor");
    };
}

function enviar() {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("No estas conectado");
        return;
    }
    
    const msg = document.getElementById("mensaje").value.trim();
    if (!msg) return;

    ws.send(msg);
    document.getElementById("mensaje").value = "";
    document.getElementById("mensaje").focus();
}

// Permitir enviar con Enter
document.getElementById("mensaje")?.addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        enviar();
    }
});

document.getElementById("password")?.addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        conectar('LOGIN');
    }
});
</script>

</body>
</html>
